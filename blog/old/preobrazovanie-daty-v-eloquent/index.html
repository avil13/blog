<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width">
    <title>Преобразование даты в Eloquent | AVIL13.com</title>
<meta name="description" content="Работа с ORM Eloquent и датами">
<link rel="canonical" href="https://avil13.com/blog/old/preobrazovanie-daty-v-eloquent/">


<meta property="og:url" content="https://avil13.com/blog/old/preobrazovanie-daty-v-eloquent/">
<meta property="og:type" content="article">
<meta property="og:title" content="Преобразование даты в Eloquent">
<meta property="og:description" content="Работа с ORM Eloquent и датами">
<meta property="og:image" content="https://avil13.com/images/graph/blog/eloquent-1.webp">


<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:domain" content="https://avil13.com">
<meta property="twitter:url" content="https://avil13.com/blog/old/preobrazovanie-daty-v-eloquent/">
<meta name="twitter:title" content="Преобразование даты в Eloquent">
<meta name="twitter:description" content="Работа с ORM Eloquent и датами">
<meta name="twitter:image" content="https://avil13.com/images/graph/blog/eloquent-1.webp">

    <link rel="apple-touch-icon" sizes="57x57" href="/images/app-icon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/images/app-icon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images/app-icon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/images/app-icon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/images/app-icon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/images/app-icon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/images/app-icon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/images/app-icon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/app-icon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="/images/app-icon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/app-icon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/images/app-icon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/app-icon/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileImage" content="/images/app-icon/ms-icon-144x144.png">


    <!-- analitycs   --><meta name="yandex-verification" content="site.seo.yandexVerification">
<meta name="google-site-verification" content="site.seo.googleVerification">

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
  (function async(m, e, t, r, i, k, a) {
    m[i] =
      m[i] ||
      function () {
        (m[i].a = m[i].a || []).push(arguments);
      };
    m[i].l = 1 * new Date();
    for (var j = 0; j < document.scripts.length; j++) {
      if (document.scripts[j].src === r) {
        return;
      }
    }
    (k = e.createElement(t)),
      (a = e.getElementsByTagName(t)[0]),
      (k.async = 1),
      (k.src = r),
      a.parentNode.insertBefore(k, a);

    // RUN
    ym(91122403, "init", {
      clickmap: true,
      trackLinks: true,
      accurateTrackBounce: true,
      trackHash: true,
    });
  })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
</script>
<noscript><div>
    <img src="https://mc.yandex.ru/watch/91122403" style="position:absolute; left:-9999px;" alt="">
  </div></noscript>
<!-- /Yandex.Metrika counter -->
  <link rel="stylesheet" href="/assets/06-vue-store-mock.5e16d523.css" /><script type="module">(()=>{const e=document.querySelector(".menu-btn");e&&e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.classList.toggle("show")})})();(async()=>(localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.toggle("dark",!0):document.documentElement.classList.toggle("dark",!1),document.getElementById("theme-toggle")?.addEventListener("click",()=>{const e=document.documentElement.classList.contains("dark");document.documentElement.classList.toggle("dark",!e),localStorage.setItem("theme",e?"":"dark")})))();(async()=>{if(!navigator.share)return;const e=document.querySelector("title")?.innerText||"",t=document.querySelector('meta[name="description"]')?.getAttribute("content")||"",c=document.querySelector('link[rel="canonical"]')?.getAttribute("href")||location.href,n=document.getElementById("share-page");n?.classList.toggle("hidden",!1),n?.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),navigator.share({title:e,text:t,url:c}).then(()=>console.log("Successful share")).catch(a=>console.log("Error sharing",a))})})();
</script></head>

  <body class="bg-white dark:bg-gray-800 dark:text-gray-200">
    <div class="sticky top-0 px-4 bg-white dark:bg-gray-800 dark:text-gray-200 opacity-95">
  <header class="container flex justify-between py-4 mx-auto md:max-w-4xl">
    <a href="/" class="text-gray-400 hover:no-underline visited:text-gray-400">AVIL13.com</a>

    <div class="flex items-center">
      <button id="theme-toggle" type="button" aria-label="Theme switcher" class="p-0.5 text-sm text-gray-500 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:focus:ring-gray-700">
        <svg class="hidden w-5 h-5 dark:block" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
        </svg>
        <svg class="w-5 h-5 dark:hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path>
        </svg>
      </button>
      
    </div>
    

    
  </header>
</div>

    <img src="https://avil13.com/images/graph/blog/eloquent-1.webp" alt="Преобразование даты в Eloquent" srcset="" class="hero-image" fetchpriority="high" height="480" sizes="100vw" width="1600">

    <main class="container max-w-4xl px-2 py-4 mx-auto prose md:px-0 lg:prose-xl dark:prose-invert">
      <article>
        <time datetime="24.06.2015" class="text-gray-400 dark:text-gray-600 text-xs">24.06.2015</time>
        <h1 id="преобразование-даты-в-eloquent">Преобразование даты в Eloquent</h1>
<p>И так. У меня сервер который работает на php5.6 + PostreSQL в качестве базы данных. Все это используется сайтом созданным на Laravel 4.2.</p>
<p>И мне понадобилось преобразовывать дату в другой формат, ибо время в БД сохраняется по Гринвичу.</p>
<p>Предположим что колонка с датой у нас называется <code>Moment</code></p>
<p>Если из БД брать данные через SQL то можно использовать прямой запрос с функцией timezone</p>
<pre class="language-sql"><code is:raw="" class="language-sql"><span class="token keyword">SELECT</span> timezone<span class="token punctuation">(</span><span class="token string">'UTC'</span><span class="token punctuation">,</span> <span class="token string">"Moment"</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"Moment"</span> <span class="token keyword">FROM</span> table_name</code></pre>
<p>Но так как мы используем Laravel, и соответственно, для работы с БД его ОРМ Eloquent, то будем использовать его модели для преобразования даты.</p>
<h4 id="для-начала-создадим-отдельно-функцию-которую-будем-вызывать-для-преобразования-даты-что-бы-везде-на-сайте-даты-выглядели-одинаково">Для начала создадим отдельно функцию которую будем вызывать для преобразования даты, что бы везде на сайте даты выглядели одинаково.</h4>
<p>Добавим файл с набором наших собственных функций хелперов.
От корня сайта путь к нему будет выглядеть вот так: <code>app/Acme/helpers.php</code>.</p>
<p>Затем в файле <code>composer.json</code> пропишем его в автолоад</p>
<pre class="language-json"><code is:raw="" class="language-json"><span class="token property">"autoload"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"classmap"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"app/commands"</span><span class="token punctuation">,</span>
            <span class="token string">"app/controllers"</span><span class="token punctuation">,</span>
            <span class="token string">"app/models"</span><span class="token punctuation">,</span>
            <span class="token string">"app/database/migrations"</span><span class="token punctuation">,</span>
            <span class="token string">"app/database/seeds"</span><span class="token punctuation">,</span>
            <span class="token string">"app/tests/TestCase.php"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"files"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"app/Acme/helpers.php"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"psr-4"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"Acme\\"</span><span class="token operator">:</span> <span class="token string">"app/Acme"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Тут мы добавили строки <code>files</code> и <code>psr-4</code>.</p>
<p>Теперь с консоли выполняем <code>composer dump-autoload</code> либо  <code>php artisan dump-autoload</code> для того что бы подгрузить все что указано в этом участке файла.</p>
<p>Теперь непосредственно к функции для преобразования даты в нашем файле <code>helpers.php</code>.</p>
<pre class="language-php"><code is:raw="" class="language-php"><span class="token php language-php"><span class="token delimiter important">&#x3C;?php</span>
<span class="token keyword">use</span> <span class="token package">Carbon<span class="token punctuation">\</span>Carbon</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Приведение к нужному формату времени
 * @param  [type] $value [description]
 * @return [type]        [description]
 */</span>
<span class="token keyword">function</span> <span class="token function-definition function">toDate</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// если получили пустое значение, то вернем его же.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// на случай если передадим объект Carbon</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$value</span><span class="token operator">-></span><span class="token function">timezone</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Europe/Moscow'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">toDateTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Если получили строку со временем и датой</span>
    <span class="token keyword">return</span> <span class="token class-name static-context">Carbon</span><span class="token operator">::</span><span class="token function">createFromTimestamp</span><span class="token punctuation">(</span><span class="token function">strtotime</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">-></span><span class="token function">timezone</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Europe/Moscow'</span><span class="token punctuation">)</span>
        <span class="token operator">-></span><span class="token function">toDateTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></code></pre>
<p>Ну и для ясности изложения файл модели для связи с таблицей БД у нас будет <code>Messages.php</code>.</p>
<pre class="language-php"><code is:raw="" class="language-php"><span class="token php language-php"><span class="token delimiter important">&#x3C;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Messages</span> <span class="token keyword">extends</span> <span class="token class-name">Eloquent</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token variable">$timestamps</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Messages'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></code></pre>
<h3 id="первый-вариант-решения-мутатор-getmomentattribute">Первый вариант решения, мутатор getMomentAttribute.</h3>
<p>Первый и самый простой вариант, это использовать <a href="http://laravel.com/docs/4.2/eloquent#accessors-and-mutators">мутатор</a> атрибутов класса.</p>
<p>Его нужно прописать в <code>Messages.php</code>, он выглядит примерно так.</p>
<pre class="language-php"><code is:raw="" class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getMomentAttribute</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">toDate</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>В названии функции нужно указать как называется столбец который нужно преобразовать.</p>
<p>В случае если название столбца в вашей БД выглядит вот так <code>create_time</code> то его название в имени функции будет выглядеть <code>CreateTime</code>, а название самой функции <code>getCreateTimeAttribute</code>.</p>
<p>В принципе, в большинстве случаев данного действия должно хватить для преобразования. Таким же способом можно изменять и любые другие элементы получаемые в модель.</p>
<h3 id="второй-вариант-решения-преобразование-даты">Второй вариант решения, преобразование даты.</h3>
<p>Так же можно использовать и вариант с преобразованием даты.</p>
<p>Для этого, в файле <code>Messages.php</code> нужно указать какие поля считать датами.</p>
<pre class="language-php"><code is:raw="" class="language-php"><span class="token keyword">public</span> <span class="token variable">$dates</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'Moment'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>Далеё можно использовать функцию описания формата даты который получаем из БД.</p>
<pre class="language-php"><code is:raw="" class="language-php"><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getDateFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string single-quoted-string">'Y-m-d H:i:s'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Меня правда как то удивило то что в файле для преобразования даты, она возвращается в том же виде в каком и передали.</p>
<p><code>vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php</code></p>
<p>В функции <code>fromDateTime</code> в строке 2644 возвращается текст отформатированный из исходного вида.
Не очень понял логику этого решения, если вы болеё проницательны, то поделитесь.</p>
<p>У меня БД возвращала строку с датой такого вида <code>2015-02-03 07:52:43.812659</code> поэтому нормально вышеуказанная функция не работала.</p>
<p>Так что был сделан такой хак.</p>
<p>В файле <code>Messages.php</code> добавлена функция:</p>
<pre class="language-php"><code is:raw="" class="language-php"><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">asDateTime</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// преобразовываем значение в  DateTime</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">strtotime</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// получаем объект Cabon для последующего преобразования</span>
    <span class="token variable">$obj</span> <span class="token operator">=</span>  <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">asDateTime</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// преобразовываем</span>
    <span class="token keyword">return</span> <span class="token function">toDate</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Из нюансов, хотелось бы отметить то что в функции <code>asDateTime</code> не обязательно создавать объект, так же как и в функции хелпере.
Просто мне так удобнеё потому что все преобразования можно легко абстрагировать от основной работы.</p>
      </article>
    </main>

    <footer class="container max-w-4xl py-8 mx-auto mt-16 mb-8 border-t border-b border-gray-200 dark:border-gray-700 md:px-0">
  <div class="flex px-6 md:space-x-24">
    <div class="flex flex-col w-full space-y-4 md:space-y-0 md:flex-row" aria-label="Footer page navigation">
  
  
  <a class="flex justify-end w-10/12 sm:w-1/2" href="/blog/old/otpravka-post-dannyh-bez-ispolzovaniya-curl" title="Отправка POST данных через PHP без использования CURL">
        <span class="truncate">Отправка POST данных через PHP без использования CURL</span>
        <span aria-hidden="true">&raquo;</span>
      </a>
</div>
    <div>
  <a href="https://avil13.com/blog/old/preobrazovanie-daty-v-eloquent/" id="share-page" class="hidden">
    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path>
    </svg>
  </a>

  
</div>
  </div>
</footer>
    <script type="application/ld+json">{
 "@context": "https://schema.org/",
 "@type": "BlogPosting",
 "author": {
  "@type": "Person",
  "name": "AVIL13"
 },
 "headline": "Преобразование даты в Eloquent",
 "image": "https://avil13.com/images/graph/blog/eloquent-1.webp",
 "datePublished": "2015-06-24T00:00:00.000Z",
 "publisher": {
  "@type": "Person",
  "name": "AVIL13",
  "jobTitle": "web-developer",
  "url": "https://avil13.com"
 }
}</script>


    <script>
        (async () => {
          window.addEventListener("load", () => {
            if ("serviceWorker" in navigator) {
              navigator.serviceWorker.register("/service-worker.js");
            }
          });
        })();
      </script>
  </body>
</html>